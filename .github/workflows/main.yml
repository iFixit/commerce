name: E2E tests

on: [push]
env:
   npm_config_userconfig: './.npmrc'
   playwright-upload-result-path: 'playwright-results'
jobs:
   playwright-run:
      timeout-minutes: 15
      strategy:
         fail-fast: false
         matrix:
            project:
               [
                  'Desktop Chrome',
                  'Desktop Firefox',
                  'Mobile Chrome',
                  'Tablet Chrome',
               ]
      runs-on: ubuntu-latest
      steps:
         - name: Checkout
           uses: actions/checkout@v3

         - name: Setup CI Environment Variables
           uses: ./.github/actions/setup-ci-env-vars
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              GITHUB_JOB_NAME: ${{ github.job }} (${{ matrix.project }})

         - name: Install Node.js
           uses: actions/setup-node@v3
           with:
              node-version: 16

         - name: Start strapi server
           run: cd backend && docker-compose up -d
           env:
              JWT_SECRET: 'ci-secret'
              API_TOKEN_SALT: 'Not_A-s3Cr3t-/Qr5iGP0g=='
         - name: Setup and cache pnpm
           uses: ./.github/actions/pnpm-setup
         - name: Install workspaces
           env:
              FONT_AWESOME_NPM_TOKEN: ${{ secrets.FONT_AWESOME_NPM_TOKEN }}
           run: pnpm install

         - name: Setup and cache playwright dependencies
           uses: ./.github/actions/playwright-setup

         - name: Build and cache frontend for with test setup
           uses: ./.github/actions/build-test-frontend
           with:
              algolia-api-key: ${{ secrets.ALGOLIA_API_KEY }}

         - name: Run Playwright Tests
           env:
              NODE_ENV: test
              NEXT_PUBLIC_STRAPI_ORIGIN: http://localhost:1337
              ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
           run: cd frontend && pnpm playwright:run --project="${{ matrix.project }}"

         - uses: actions/upload-artifact@v3
           if: failure()
           with:
              name: playwright-artifacts
              path: frontend/tests/playwright/test-results/artifacts
              retention-days: 7

         - name: Prepare results to upload for project matrix
           if: success() || failure()
           id: test-result
           run: |
              MATRIX_NAME=$(echo "${{ matrix.project }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
              RESULT_ORIGINAL_NAME="playwright-result-$BUILD_COMMIT"
              RESULT_FINAL_NAME="$RESULT_ORIGINAL_NAME-$MATRIX_NAME"
              mv "frontend/$RESULT_ORIGINAL_NAME" "frontend/$RESULT_FINAL_NAME"
              RESULT_PATH="frontend/$RESULT_FINAL_NAME"
              echo "Result path: $RESULT_PATH"
              echo "result-path=$RESULT_PATH" >> $GITHUB_OUTPUT

         - name: Upload Playwright Test Result Metrics
           if: success() || failure()
           uses: actions/upload-artifact@v3
           with:
              name: ${{ env.playwright-upload-result-path }}
              path: ${{ steps.test-result.outputs.result-path }}
              retention-days: 1
