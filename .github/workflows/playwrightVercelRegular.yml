name: Playwright Vercel site - Regular Preview

on: [push]
env:
   npm_config_userconfig: './.npmrc'
jobs:
   test_setup_regular:
      name: Test setup for regular preview
      runs-on: ubuntu-latest
      outputs:
         preview_url: ${{ steps.waitForVercelPreviewDeployment.outputs.url }}
      steps:
         - name: Wait for Vercel preview deployment to be ready
           uses: patrickedqvist/wait-for-vercel-preview@v1.2.0
           id: waitForVercelPreviewDeployment
           with:
              token: ${{ secrets.GITHUB_TOKEN }}
              max_timeout: 1000
              check_interval: 5
              environment: Preview â€“ react-commerce
              path: Parts

   playwright_tests:
      needs: test_setup_regular
      runs-on: ubuntu-latest
      steps:
         - name: Checkout
           uses: actions/checkout@v3

         - name: Setup and cache pnpm
           uses: ./.github/actions/pnpm-setup
         - name: Install workspaces
           env:
              FONT_AWESOME_NPM_TOKEN: ${{ secrets.FONT_AWESOME_NPM_TOKEN }}
           run: pnpm install

         - name: Get installed Playwright version
           id: playwright-version
           run: echo "PLAYWRIGHT_VERSION=$(pnpm list -r "@playwright/test" | grep "@playwright/test" | tr -dc 1-9.)" >> $GITHUB_ENV

         - name: Cache playwright binaries
           uses: actions/cache@v3
           id: playwright-cache
           with:
              path: ~/.cache/ms-playwright
              key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}
              restore-keys: ${{ runner.os }}-playwright-

         - name: Install Playwright Dependencies
           run: cd frontend && npx playwright install
           if: steps.playwright-cache.outputs.cache-hit != 'true'

         - name: Run playwright tests
           run: cd frontend && pnpm playwright:run
           env:
              PLAYWRIGHT_TEST_BASE_URL: ${{ needs.test_setup_regular.outputs.preview_url }}

         - uses: actions/upload-artifact@v2
           if: failure()
           with:
              name: playwright-screenshots
              path: frontend/tests/playwright/test-results/artifacts
